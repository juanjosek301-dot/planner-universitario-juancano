<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UPlanner - Vista Profesor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vista_profesor.css') }}" />
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <img src="{{ url_for('static', filename='public/images/Uplannner.png') }}" alt="Logo UPlanner" />
    </div>

    <nav>
      <ul>
        <li>
          <a href="#" id="btn-perfil" title="Perfil">
            <img src="{{ url_for('static', filename='public/images/perfil_profesor.png') }}" alt="Perfil" />
          </a>
        </li>
        <li>
          <a href="#" id="btn-mensajes" title="Mensajes">
            <img src="{{ url_for('static', filename='public/images/mensajes..png') }}" alt="Mensajes" />
          </a>
          <a href="#" id="btn-ver-cursos" title="Mis Cursos"> <img src="{{ url_for('static', filename='public/images/cursos.png') }}" alt="Cursos" /> </a>
        </li>
      </ul>
    </nav>

    <button id="cerrar-sesion">Cerrar sesi√≥n</button>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">

    <header class="main-header">
      <h1 id="bienvenida">Bienvenido, Profesor</h1>
    </header>

    <!-- PERFIL -->
    <section id="perfil" class="card" style="display:none;">
      <h2>üë§ Mi Perfil</h2>
      <p><strong>Nombre:</strong> <span id="perfil-nombre"></span></p>
      <p><strong>Correo:</strong> <span id="perfil-correo"></span></p>
      <p><strong>Rol:</strong> <span id="perfil-rol"></span></p>
    </section>

    <!-- CREAR CURSO -->
    <section class="card crear-curso">
      <h2>üìò Crear Nuevo Curso</h2>
      <form id="form-curso" class="form-curso">
        <div class="form-group">
          <label for="nombre">Nombre del curso</label>
          <input type="text" id="nombre" placeholder="Ejemplo: F√≠sica II" required />
        </div>
        <div class="form-group">
          <label for="codigo">C√≥digo del curso</label>
          <input type="text" id="codigo" placeholder="Ejemplo: FIS-2025" required />
        </div>
        <div class="form-group">
          <label for="descripcion">Descripci√≥n</label>
          <textarea id="descripcion" placeholder="Describe brevemente el curso..." rows="3"></textarea>
        </div>
        <button type="submit" class="btn-crear">+ Crear curso</button>
      </form>
    </section>

    <!-- MIS CURSOS -->
    <section class="card mis-cursos">
      <h2>Mis Cursos</h2>
      <ul id="lista-cursos"></ul>
    </section>

    <!-- CREAR ACTIVIDAD -->
    <section class="card crear-actividad">
      <h2>Crear nueva actividad</h2>
      <form id="form-actividad">
        <label>Curso:</label>
        <select id="select-curso">
          <option value="">Selecciona un curso</option>
        </select>

        <label>T√≠tulo:</label>
        <input type="text" id="titulo" required>

        <label>Descripci√≥n:</label>
        <textarea id="descripcion" required></textarea>

        <label>Fecha de entrega:</label>
        <input type="date" id="fecha_entrega" required>

        <label>Peso (%):</label>
        <input type="number" id="peso" min="1" max="100" required>

        <button type="submit" class="btn-crear">Crear Actividad</button>
      </form>
    </section>

    <!-- MONTAR NOTA -->
    <section class="card montar-nota">
      <h2>üìÑ Montar Nota de Entregas</h2>
      <select id="select-actividad">
        <option value="">-- Selecciona actividad --</option>
      </select>

      <select id="select-entrega">
        <option value="">-- Selecciona entrega --</option>
      </select>

      <input type="number" id="calificacion" placeholder="Ingresa la nota" min="0" max="5">

      <button id="btn-montar-nota" class="btn-crear">Montar Nota</button>

      <div id="resultado-nota"></div>
    </section>

    <section id="dashboard-progreso">
      <h2>üìä Progreso de Estudiantes</h2>
      <select id="select-curso-progreso">
        <option value="">Selecciona un curso</option>
      </select>

      <div id="tabla-progreso"></div>
    </section>

  </main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("form-curso");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // üß† Recuperar el id del profesor del localStorage
      const id_profesor = parseInt(localStorage.getItem("id_profesor"));
      console.log("üß† ID del profesor:", id_profesor);

      if (!id_profesor) {
        alert("‚ùå Error: No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
        window.location.href = "/"; 
        return;
      }

      const curso = {
        nombre: document.getElementById("nombre").value,
        codigo: document.getElementById("codigo").value,
        descripcion: document.getElementById("descripcion").value,
        id_profesor: parseInt(id_profesor)
      };

      try {
        const res = await fetch("/api/cursos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(curso)
        });

        const data = await res.json();
        console.log("üì• Respuesta del servidor:", data);
        if (data.id) {
          // Guarda el ID del curso reci√©n creado
          localStorage.setItem("id_curso", data.id);
          alert("‚úÖ Curso creado correctamente");
          }

        if (res.ok) {
          alert("‚úÖ Curso creado correctamente");
          form.reset();
        } else {
          alert("‚ùå Error: " + data.error);
        }
      } catch (error) {
        console.error("üö® Error al enviar:", error);
        alert("Error al conectar con el servidor");
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const listaCursos = document.getElementById("lista-cursos");
    const btnVerCursos = document.getElementById("btn-ver-cursos");

    btnVerCursos.addEventListener("click", async (e) => {
      e.preventDefault();

      const id_profesor = parseInt(localStorage.getItem("id_profesor"));
      if (!id_profesor) {
        alert("‚ö†Ô∏è No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
        return;
      }

      try {
        const res = await fetch(`/api/cursos/${id_profesor}`);
        const data = await res.json();

        listaCursos.innerHTML = ""; // limpia la lista anterior

        if (data.length === 0) {
          listaCursos.innerHTML = "<li>No tienes cursos creados a√∫n.</li>";
        } else {
          data.forEach(curso => {
            const li = document.createElement("li");
            li.textContent = `${curso.nombre} (${curso.codigo}) - ${curso.descripcion}`;
            listaCursos.appendChild(li);
          });
        }

      } catch (error) {
        console.error("üö® Error al cargar cursos:", error);
        alert("Error al cargar los cursos del profesor");
      }
    });
  });
</script>

<!-- mejorar diseno de perfil -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btnPerfil = document.getElementById("btn-perfil");
    const perfilSection = document.getElementById("perfil");

    btnPerfil.addEventListener("click", async (e) => {
      e.preventDefault();

      const id_profesor = parseInt(localStorage.getItem("id_profesor"));
      if (!id_profesor) {
        alert("‚ö†Ô∏è No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
        return;
      }

      try {
      const res = await fetch(`/api/perfil/${id_profesor}`);
      const data = await res.json();

      if (res.ok) {
        document.getElementById("perfil-nombre").textContent = data.nombre;
        document.getElementById("perfil-correo").textContent = data.correo;
        document.getElementById("perfil-rol").textContent = data.rol;

        // Mostrar solo la secci√≥n de perfil
        document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
        perfilSection.style.display = "block";
      } else {
        alert(data.error || "Error al obtener perfil");
      }

    } catch (error) {
      console.error("üö® Error al cargar perfil:", error);
      alert("Error al cargar perfil del profesor");
    }
  });
});
</script> 

<!-- implementacion crear tarea ("REVISAR DESCRIPCION BASE DE DATOS") -->
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const id_profesor = localStorage.getItem("id_profesor");

    if (!id_profesor) {
      alert("‚ö†Ô∏è No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
      window.location.href = "/";
      return;
    }

    const selectCurso = document.getElementById("select-curso");

    try {
      const res = await fetch(`/api/cursos/${id_profesor}`);
      const cursos = await res.json();

      if (cursos.length === 0) {
        alert("No tienes cursos creados a√∫n. Crea uno antes de agregar actividades.");
        return;
      }

      // üîπ Llenar el select con los cursos
      cursos.forEach(curso => {
        const option = document.createElement("option");
        option.value = curso.id;
        option.textContent = `${curso.nombre} (${curso.codigo})`;
        selectCurso.appendChild(option);
      });

    // Si solo hay un curso, seleccionarlo autom√°ticamente
      if (cursos.length === 1) {
        selectCurso.value = cursos[0].id;
      }

    } catch (error) {
      console.error("üö® Error al cargar cursos:", error);
      alert("Error al obtener los cursos del profesor.");
    }

    // üîπ Evento submit del formulario
    const form = document.getElementById("form-actividad");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const id_curso = selectCurso.value;
      const titulo = document.getElementById("titulo").value;
      const descripcion = document.getElementById("descripcion").value;
      const fecha_entrega = document.getElementById("fecha_entrega").value;
      const peso = document.getElementById("peso").value;

      if (!id_curso) {
        alert("Selecciona un curso antes de crear la actividad.");
        return;
      }

      try {
        const res = await fetch("/api/actividades", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id_curso,
            titulo,          
            descripcion,
            fecha_entrega,
            peso
          })
        });

        console.log({id_curso, titulo, descripcion, fecha_entrega, peso});

        const data = await res.json();
        alert(data.mensaje || data.error);

      } catch (error) {
        console.error("üö® Error al crear actividad:", error);
        alert("Error al conectar con el servidor.");
      }
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const id_profesor = parseInt(localStorage.getItem("id_profesor"));
    const selectActividad = document.getElementById("select-actividad");
    const selectEntrega = document.getElementById("select-entrega");
    const btnMontarNota = document.getElementById("btn-montar-nota");
    const resultadoDiv = document.getElementById("resultado-nota");

    if (!id_profesor) {
        resultadoDiv.innerHTML = '<p style="color:red;">No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.</p>';
        return;
    }

    // 1Ô∏è‚É£ Cargar actividades del profesor
    async function cargarActividades() {
        try {
            const res = await fetch(`/api/profesor/${id_profesor}`);
            const actividades = await res.json();

            selectActividad.innerHTML = '<option value="">-- Selecciona actividad --</option>';
            actividades.forEach(act => {
                const option = document.createElement("option");
                option.value = act.id;
                option.textContent = `${act.titulo} (${act.id_curso})`;
                selectActividad.appendChild(option);
            });
        } catch (error) {
            console.error("Error al cargar actividades:", error);
            resultadoDiv.innerHTML = '<p style="color:red;">Error al cargar actividades</p>';
        }
    }

    // 2Ô∏è‚É£ Cargar entregas seg√∫n actividad seleccionada
    selectActividad.addEventListener("change", async () => {
        const id_actividad = parseInt(selectActividad.value);
        selectEntrega.innerHTML = '<option value="">-- Selecciona entrega --</option>';
        if (!id_actividad) return;

        try {
            const res = await fetch(`/api/actividad/${id_actividad}`);
            const entregas = await res.json();

            entregas.forEach(ent => {
                const option = document.createElement("option");
                option.value = ent.id_estudiante;
                option.textContent = `Estudiante ID: ${ent.id_estudiante} - Estado: ${ent.estado} - Nota: ${ent.calificacion || "N/A"}`;
                selectEntrega.appendChild(option);
            });
        } catch (error) {
            console.error("Error al cargar entregas:", error);
            resultadoDiv.innerHTML = '<p style="color:red;">Error al cargar entregas</p>';
        }
    });

    // 3Ô∏è‚É£ Montar nota
    btnMontarNota.addEventListener("click", async () => {
        const id_actividad = parseInt(selectActividad.value);
        const id_estudiante = parseInt(selectEntrega.value);
        const calificacion = parseFloat(document.getElementById("calificacion").value);

        if (!id_actividad || !id_estudiante || isNaN(calificacion)) {
            resultadoDiv.innerHTML = '<p style="color:red;">Completa todos los campos</p>';
            return;
        }

        try {
            const res = await fetch("/api/montar-nota", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id_actividad, id_estudiante, calificacion, id_profesor })
            });

            const data = await res.json();
            console.log("üì¶ Respuesta del servidor:", data);

            if (res.ok) {
                resultadoDiv.innerHTML = `<p style="color:green;">${data.message}</p>`;
                // Refresca entregas para mostrar la nota reci√©n montada
                selectActividad.dispatchEvent(new Event("change"));
            } else {
                resultadoDiv.innerHTML = `<p style="color:red;">${data.error}</p>`;
            }
        } catch (error) {
            console.error(error);
            resultadoDiv.innerHTML = '<p style="color:red;">Error al conectar con el servidor</p>';
        }
    });

    // Inicializamos actividades al cargar la p√°gina
    cargarActividades();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const selectCurso = document.getElementById("select-curso-progreso");
  const tablaDiv = document.getElementById("tabla-progreso");
  const id_profesor = parseInt(localStorage.getItem("id_profesor"));

  if (!id_profesor) {
    tablaDiv.innerHTML = '<p style="color:red;">No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.</p>';
    return;
  }

  // 1Ô∏è‚É£ Cargar cursos del profesor
  async function cargarCursos() {
    try {
      const res = await fetch(`/api/cursos/${id_profesor}`);
      const cursos = await res.json();

      selectCurso.innerHTML = '<option value="">-- Selecciona un curso --</option>';
      cursos.forEach(c => {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = c.nombre;
        selectCurso.appendChild(option);
      });
    } catch (error) {
      console.error("Error al cargar cursos:", error);
      tablaDiv.innerHTML = '<p style="color:red;">Error al cargar cursos</p>';
    }
  }

  // 2Ô∏è‚É£ Cargar progreso al seleccionar curso
  selectCurso.addEventListener("change", async () => {
    const id_curso = selectCurso.value;
    if (!id_curso) {
      tablaDiv.innerHTML = "";
      return;
    }

    try {
      const res = await fetch(`/api/progreso/${id_curso}`);
      const data = await res.json();

      if (data.error) {
        tablaDiv.innerHTML = `<p style="color:red;">${data.error}</p>`;
        return;
      }

      // Construir tabla
      let html = "<table class='tabla-progreso'><thead><tr><th>Estudiante</th>";
      data.actividades.forEach(a => html += `<th>${a}</th>`);
      html += "<th>Promedio</th></tr></thead><tbody>";

      data.estudiantes.forEach(est => {
        html += `<tr><td>${est.nombre}</td>`;
        est.actividades.forEach(act => {
          let color = "black";
          if (act.estado === "Pendiente") color = "orange";
          else if (act.calificacion !== null && act.calificacion < 3) color = "red";
          html += `<td style="color:${color}">${act.calificacion !== null ? act.calificacion : act.estado}</td>`;
        });
        let promColor = (est.promedio !== null && est.promedio < 3) ? "red" : "black";
        html += `<td style="color:${promColor}">${est.promedio !== null ? est.promedio : "N/A"}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      tablaDiv.innerHTML = html;

    } catch (error) {
      console.error(error);
      tablaDiv.innerHTML = '<p style="color:red;">Error al conectar con el servidor</p>';
    }
  });

  // Inicializamos cursos al cargar la p√°gina
  cargarCursos();
});
</script>


</body>
</html>