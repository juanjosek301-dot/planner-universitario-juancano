<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UPlanner - Vista Profesor</title>

  <!-- ‚úÖ CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/vista_profesor.css') }}" />
</head>
<body>
  <!-- üîπ Sidebar -->
<aside class="sidebar">
  <div class="logo">
    <img src="{{ url_for('static', filename='public/images/Uplannner.png') }}" alt="Logo UPlanner" />
  </div>

  <nav>
    <ul>
      <!-- üë§ Perfil -->
      <li>
        <a href="#" id="btn-perfil" title="Perfil">
          <img src="{{ url_for('static', filename='public/images/perfil_profesor.png') }}" alt="Perfil" />
        </a>
      </li>

      <!-- üìö Cursos -->
      <li>
        <a href="#" id="btn-ver-cursos" title="Mis Cursos">
          <img src="{{ url_for('static', filename='public/images/cursos.png') }}" alt="Cursos" />
        </a>
      </li>

      <!-- üí¨ Mensajes -->
      <li>
        <a href="#" id="btn-mensajes" title="Mensajes">
          <img src="{{ url_for('static', filename='public/images/mensajes..png') }}" alt="Mensajes" />
        </a>
      </li>
    </ul>
  </nav>

  <button id="cerrar-sesion">Cerrar sesi√≥n</button>
</aside>

  <section id="perfil" style="display:none;">
    <h2>üë§ Mi Perfil</h2>
    <p><strong>Nombre:</strong> <span id="perfil-nombre"></span></p>
    <p><strong>Correo:</strong> <span id="perfil-correo"></span></p>
    <p><strong>Rol:</strong> <span id="perfil-rol"></span></p>
  </section>

  <li><a href="#" id="btn-perfil">
    <img src="{{ url_for('static', filename='public/images/perfil.png') }}" alt="Perfil" />
  </a></li>

  <!-- üî∏ Contenido principal -->
  <main class="main-content">
    <header class="main-header">
      <h1 id="bienvenida">Bienvenido, Profesor</h1>
    </header>

    <!-- üìö Crear Curso -->
    <section class="crear-curso">
      <h2>üìò Crear Nuevo Curso</h2>
      <form id="form-curso" class="form-curso">
        <div class="form-group">
          <label for="nombre">Nombre del curso</label>
          <input type="text" id="nombre" placeholder="Ejemplo: F√≠sica II" required />
        </div>

        <div class="form-group">
          <label for="codigo">C√≥digo del curso</label>
          <input type="text" id="codigo" placeholder="Ejemplo: FIS-2025" required />
        </div>

        <div class="form-group">
          <label for="descripcion">Descripci√≥n</label>
          <textarea id="descripcion" placeholder="Describe brevemente el curso..." rows="3"></textarea>
        </div>

        <button type="submit" id="btn-crear-curso" class="btn-crear">+ Crear curso</button>
      </form>
    </section>

    <!-- üìò Mis Cursos -->
    <section class="mis-cursos">
      <h2>Mis Cursos</h2>
      <ul id="lista-cursos"></ul>
    </section>

    <section id="crear-actividad">
      <h2>Crear nueva actividad</h2>

      <form id="form-actividad">
        <label>Curso:</label>
        <select id="select-curso">
          <option value="">Selecciona un curso</option>
        </select>

        <label>titulo:</label>
        <input type="text" id="titulo" required>

        <label>Descripci√≥n:</label>
        <textarea id="descripcion" required></textarea>

        <label>Fecha de entrega:</label>
        <input type="date" id="fecha_entrega" required>

        <label>Peso (%):</label>
        <input type="number" id="peso" min="1" max="100" required>

        <button type="submit">Crear Actividad</button>
      </form>
    </section>
  </main>

  </main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("form-curso");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // üß† Recuperar el id del profesor del localStorage
      const id_profesor = parseInt(localStorage.getItem("id_profesor"));
      console.log("üß† ID del profesor:", id_profesor);

      if (!id_profesor) {
        alert("‚ùå Error: No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
        window.location.href = "/"; 
        return;
      }

      const curso = {
        nombre: document.getElementById("nombre").value,
        codigo: document.getElementById("codigo").value,
        descripcion: document.getElementById("descripcion").value,
        id_profesor: parseInt(id_profesor)
      };

      try {
        const res = await fetch("/api/cursos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(curso)
        });

        const data = await res.json();
        console.log("üì• Respuesta del servidor:", data);
        if (data.id) {
          // Guarda el ID del curso reci√©n creado
          localStorage.setItem("id_curso", data.id);
          alert("‚úÖ Curso creado correctamente");
          }

        if (res.ok) {
          alert("‚úÖ Curso creado correctamente");
          form.reset();
        } else {
          alert("‚ùå Error: " + data.error);
        }
      } catch (error) {
        console.error("üö® Error al enviar:", error);
        alert("Error al conectar con el servidor");
      }
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const listaCursos = document.getElementById("lista-cursos");
    const btnVerCursos = document.getElementById("btn-ver-cursos");

    btnVerCursos.addEventListener("click", async (e) => {
      e.preventDefault();

      const id_profesor = parseInt(localStorage.getItem("id_profesor"));
      if (!id_profesor) {
        alert("‚ö†Ô∏è No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
        return;
      }

      try {
        const res = await fetch(`/api/cursos/${id_profesor}`);
        const data = await res.json();

        listaCursos.innerHTML = ""; // limpia la lista anterior

        if (data.length === 0) {
          listaCursos.innerHTML = "<li>No tienes cursos creados a√∫n.</li>";
        } else {
          data.forEach(curso => {
            const li = document.createElement("li");
            li.textContent = `${curso.nombre} (${curso.codigo}) - ${curso.descripcion}`;
            listaCursos.appendChild(li);
          });
        }

      } catch (error) {
        console.error("üö® Error al cargar cursos:", error);
        alert("Error al cargar los cursos del profesor");
      }
    });
  });
</script>

<!-- mejorar diseno de perfil -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btnPerfil = document.getElementById("btn-perfil");
    const perfilSection = document.getElementById("perfil");

    btnPerfil.addEventListener("click", async (e) => {
      e.preventDefault();

      const id_profesor = parseInt(localStorage.getItem("id_profesor"));
      if (!id_profesor) {
        alert("‚ö†Ô∏è No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
        return;
      }

      try {
      const res = await fetch(`/api/perfil/${id_profesor}`);
      const data = await res.json();

      if (res.ok) {
        document.getElementById("perfil-nombre").textContent = data.nombre;
        document.getElementById("perfil-correo").textContent = data.correo;
        document.getElementById("perfil-rol").textContent = data.rol;

        // Mostrar solo la secci√≥n de perfil
        document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
        perfilSection.style.display = "block";
      } else {
        alert(data.error || "Error al obtener perfil");
      }

    } catch (error) {
      console.error("üö® Error al cargar perfil:", error);
      alert("Error al cargar perfil del profesor");
    }
  });
});
</script> 

<!-- implementacion crear tarea ("REVISAR DESCRIPCION BASE DE DATOS") -->
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const id_profesor = localStorage.getItem("id_profesor");

    if (!id_profesor) {
      alert("‚ö†Ô∏è No se encontr√≥ el ID del profesor. Inicia sesi√≥n nuevamente.");
      window.location.href = "/";
      return;
    }

    const selectCurso = document.getElementById("select-curso");

    try {
      const res = await fetch(`/api/cursos/${id_profesor}`);
      const cursos = await res.json();

      if (cursos.length === 0) {
        alert("No tienes cursos creados a√∫n. Crea uno antes de agregar actividades.");
        return;
      }

      // üîπ Llenar el select con los cursos
      cursos.forEach(curso => {
        const option = document.createElement("option");
        option.value = curso.id;
        option.textContent = `${curso.nombre} (${curso.codigo})`;
        selectCurso.appendChild(option);
      });

    // Si solo hay un curso, seleccionarlo autom√°ticamente
      if (cursos.length === 1) {
        selectCurso.value = cursos[0].id;
      }

    } catch (error) {
      console.error("üö® Error al cargar cursos:", error);
      alert("Error al obtener los cursos del profesor.");
    }

    // üîπ Evento submit del formulario
    const form = document.getElementById("form-actividad");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const id_curso = selectCurso.value;
      const titulo = document.getElementById("titulo").value;
      const descripcion = document.getElementById("descripcion").value;
      const fecha_entrega = document.getElementById("fecha_entrega").value;
      const peso = document.getElementById("peso").value;

      if (!id_curso) {
        alert("Selecciona un curso antes de crear la actividad.");
        return;
      }

      try {
        const res = await fetch("/api/actividades", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id_curso,
            titulo,          
            descripcion,
            fecha_entrega,
            peso
          })
        });

        console.log({id_curso, titulo, descripcion, fecha_entrega, peso});

        const data = await res.json();
        alert(data.mensaje || data.error);

      } catch (error) {
        console.error("üö® Error al crear actividad:", error);
        alert("Error al conectar con el servidor.");
      }
  });
});
</script>

</body>
</html>